<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<script src="https://cdn.jsdelivr.net/npm/p5@1.11.3/lib/p5.js"></script>
    <title>I am a Hologram</title>
    <link rel="stylesheet" href="./p5.css">
</head>

<body>   
	<h1>I am a Hologram</h1>
    <script>
        //code for a popup with instructions can go here
        let topMargin = 50*2;
    </script>
    
    <script>
    let video;
    let bkgd;
    let replace;
    // How different must a pixel be to be a foreground pixel
    let threshold = 20;

    function setup() {
        video = createCapture(VIDEO);
        video.size(320, 240);
        video.hide();
        createCanvas(round((video.width / video.height) * (windowHeight-topMargin)), windowHeight-topMargin);
        bkgd = createImage(video.width, video.height);
        replace = createImage(video.width, video.height);
//        createCanvas(windowWidth, windowHeight-topMargin);
        setupScene();
    }

    function setupScene() {
        noLoop();
        let start = millis();
        let delay = 1000;
        setTimeout(() => {
            showMessage("Stand clear.")
        }, delay);
        setTimeout(() => {
            loop();
            showMessage("3");
        }, delay * 2);
        setTimeout(() => {
            showMessage("2")
        }, delay * 3);
        setTimeout(() => {
            showMessage("1")
        }, delay * 4);
        setTimeout(initialize, delay * 5);
    }

    function showMessage(message) {
        clear();
        fill(0, 0, 0);
        rect(0, 0, width, height);
        textSize(50);
        let messageWidth = textWidth(message);
        //draw and center the text
        fill(255);
        text(message, (width / 2) - (messageWidth / 2), height / 2);
    }


    let r1, g1, b1, r2, g2, b2, diff, i;

    function draw() {

        replace.loadPixels();
        video.loadPixels();
        bkgd.loadPixels();
        for (let x = 0; x < video.width; x++) {
            for (let y = 0; y < video.height; y++) {
                let i = ((y * video.width) + x) * 4;
                //compare the foreground and background color
                r1 = video.pixels[i];
                g1 = video.pixels[i + 1];
                b1 = video.pixels[i + 2];
                r2 = bkgd.pixels[i];
                g2 = bkgd.pixels[i + 1];
                b2 = bkgd.pixels[i + 2];
                diff = dist(r1, g1, b1, r2, g2, b2);

                //Is the foreground color different from the background color
                if (diff > threshold) {
                    // If so, display the foreground color but make it a bit bluer
                    replace.pixels[i] = r1;
                    replace.pixels[i + 1] = g1;
                    replace.pixels[i + 2] = constrain(b1 + 150, 0, 255);
                    replace.pixels[i + 3] = 200;
                } else {
                    //show the background color
                    replace.pixels[i] = r2;
                    replace.pixels[i + 1] = g2;
                    replace.pixels[i + 2] = b2;
                }
                //add some stripes to the hologram; the randomness makes them jittery 
                let position = random([2, 4]);
                if (y % position == 0 || y % position + 1 == 0) {
                    replace.pixels[i + 3] = 0;
                }
            }
        }
        //draw the background
        copy(bkgd, 0, 0, bkgd.width, bkgd.height, 0, 0, round((video.width / video.height) * height), height);
        replace.updatePixels();
        copy(replace, 0, 0, replace.width, replace.height, 0, 0, round((video.width / video.height) * height), height);
    }

    function mousePressed() {
        initialize();
    }

    function initialize() {
        replace.copy(video, 0, 0, video.width, video.height, 0, 0, video.width, video.height);
        bkgd.copy(video, 0, 0, video.width, video.height, 0, 0, video.width, video.height);
    }
    </script>
</body>

</html>